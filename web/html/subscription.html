{{ template "page/head_start" .}}
<script src="{{ .base_path }}assets/moment/moment.min.js"></script>
<script src="{{ .base_path }}assets/moment/moment-jalali.min.js?{{ .cur_ver }}"></script>
<script src="{{ .base_path }}assets/vue/vue.min.js?{{ .cur_ver }}"></script>
<script src="{{ .base_path }}assets/ant-design-vue/antd.min.js"></script>
<script src="{{ .base_path }}assets/js/util/index.js?{{ .cur_ver }}"></script>
<script src="{{ .base_path }}assets/js/util/date-util.js?{{ .cur_ver }}"></script>
<script src="{{ .base_path }}assets/qrcode/qrious2.min.js?{{ .cur_ver }}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>

<style>
/* ====== General Styles ====== */
body, html, #app {
    margin: 0;
    padding: 0;
    height: 100%;
    font-family: 'Poppins', sans-serif;
    color: #e0e0e0;
    background: #0d0c1d;
    overflow-x: hidden;
}

.ant-layout {
    background: transparent !important;
}

/* ====== Elegant Card Design ====== */
.elegant-card {
    background: #1a1a2e !important;
    border: none !important;
    border-radius: 20px !important;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5) !important;
    margin-bottom: 24px;
}

.elegant-card .ant-card-head {
    border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
}

.elegant-card .ant-card-head-title, .elegant-card .ant-card-extra {
    color: #fff !important;
    font-weight: 600;
}

/* ====== Section Headings ====== */
.section-heading {
    font-size: 1.1rem;
    font-weight: 600;
    color: #a3d9ff;
    margin-bottom: 20px;
    padding-left: 5px;
    border-left: 3px solid #f3a3ff;
}

/* ====== QR Code Section ====== */
.qr-container-flex {
    display: flex;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
}

.qr-box {
    text-align: center;
    padding: 15px;
    border-radius: 15px;
    background: #2a2a47;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    transition: transform 0.2s ease-in-out;
}

.qr-box:hover {
    transform: translateY(-5px);
}

.qr-box canvas {
    border-radius: 10px;
    width: 100% !important;
    height: 100% !important;
}

.qr-label {
    margin-top: 10px;
    font-size: 0.9rem;
    color: #a3d9ff;
}

/* ====== Info Grid ====== */
.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
}

.info-item {
    padding: 15px;
    background: #2a2a47;
    border-radius: 10px;
    display: flex;
    align-items: center;
    gap: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    transition: transform 0.2s, box-shadow 0.2s;
}

.info-item:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
}

.info-icon {
    font-size: 20px;
    color: #f3a3ff;
}

.info-text {
    flex-grow: 1;
}

.info-label {
    font-size: 0.8rem;
    color: #999;
}

.info-value {
    font-size: 1rem;
    font-weight: 600;
    color: #fff;
}

/* ====== Links & Buttons Section ====== */
.link-buttons {
    display: flex;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
    margin-top: 30px;
}

.link-button {
    background: linear-gradient(45deg, #a3d9ff, #f3a3ff) !important;
    color: #1a1a2e !important;
    font-weight: 600 !important;
    border: none !important;
    border-radius: 10px !important;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3) !important;
    height: 48px;
    font-size: 1rem;
    transition: all 0.3s ease;
}

.link-button:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4) !important;
}

.ant-dropdown-menu {
    background: #1a1a2e !important;
    border-radius: 10px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.3);
}

.ant-dropdown-menu-item {
    color: #e0e0e0 !important;
}

.ant-dropdown-menu-item:hover {
    background: #2a2a47 !important;
    color: #fff !important;
}

.ant-descriptions-title, .ant-descriptions-item-label {
    color: #fff !important;
}

.ant-descriptions-item-content {
    color: #a3d9ff !important;
}

.chart-container {
    position: relative;
    height: 250px;
    width: 250px;
    margin: auto;
}

/* ====== Responsive Styles for Mobile ====== */
@media (max-width: 768px) {
    .elegant-card {
        width: 90vw;
        max-width: 500px;
        height: auto; /* اجازه می‌ده محتوا خودش ارتفاع بده */
        border-radius: 15px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin: 10px auto;
    }

    .chart-container {
        width: 100%;
        max-width: 250px;
        height: 250px;
        margin: auto;
    }

    .qr-container-flex {
        flex-direction: column;
        gap: 15px;
        align-items: center;
    }

    .link-buttons {
        flex-direction: column;
        gap: 10px;
    }

    .info-grid {
        grid-template-columns: 1fr !important;
    }

    .ant-descriptions-item-label,
    .ant-descriptions-item-content {
        display: block !important;
        width: 100% !important;
    }

    .qr-box {
        width: 200px; /* اندازه ثابت برای QR روی موبایل */
        height: 200px;
    }
}

</style>

{{ template "page/head_end" .}}

{{ template "page/body_start" .}}
<a-layout id="app" v-cloak :class="themeSwitcher.currentTheme">
    <a-layout-content class="p-2">
        <a-row type="flex" justify="center" class="mt-5">
            <a-col :xs="24" :sm="22" :md="18" :lg="16" :xl="14">
                <a-card class="elegant-card">
                    <template #title>
                        <a-space>
                            <span>{{ i18n "subscription.title" }}</span>
                            <a-tag>{{ .sId }}</a-tag>
                        </a-space>
                    </template>
                    <template #extra>
                        <a-popover
                            :overlay-class-name="themeSwitcher.currentTheme"
                            title='{{ i18n "menu.settings" }}'
                            placement="bottomRight" trigger="click">
                            <template #content>
                                <a-space direction="vertical" :size="10">
                                    <a-theme-switch-login></a-theme-switch-login>
                                    <span>{{ i18n "pages.settings.language" }}</span>
                                    <a-select ref="selectLang" class="w-100"
                                             v-model="lang"
                                             @change="LanguageManager.setLanguage(lang)"
                                             :dropdown-class-name="themeSwitcher.currentTheme">
                                        <a-select-option :value="l.value"
                                                         label="English"
                                                         v-for="l in LanguageManager.supportedLanguages"
                                                         :key="l.value">
                                            <span role="img" :aria-label="l.name" v-text="l.icon"></span>
                                            &nbsp;&nbsp;<span v-text="l.name"></span>
                                        </a-select-option>
                                    </a-select>
                                </a-space>
                            </template>
                            <a-button shape="circle" icon="setting"></a-button>
                        </a-popover>
                    </template>
                    <a-row :gutter="[16, 16]">
                        <a-col :xs="24" :sm="24" :md="12" :lg="12" :xl="12" class="d-flex align-items-center justify-content-center">
                            <div class="chart-container">
                                <canvas id="usageChart"></canvas>
                                <div v-if="isUnlimited" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                    <a-tag color="purple" style="font-size: 1rem; padding: 5px 10px;">{{ i18n "subscription.unlimited" }}</a-tag>
                                </div>
                            </div>
                        </a-col>

                        <a-col :xs="24" :sm="24" :md="12" :lg="12" :xl="12">
                             <h3 class="section-heading">{{ i18n "subscription.details" }}</h3>
                            <a-descriptions bordered :column="1" size="small">
                                <a-descriptions-item label='{{ i18n "subscription.subId" }}'>[[ app.sId ]]</a-descriptions-item>
                                <a-descriptions-item label='{{ i18n "subscription.status" }}'>
                                    <template v-if="isUnlimited">
                                        <a-tag color="purple">{{ i18n "subscription.unlimited" }}</a-tag>
                                    </template>
                                    <template v-else>
                                        <a-tag :color="isActive && (!app.expireMs || app.expireMs > Date.now()) ? 'green' : 'red'">
                                            [[ isActive && (!app.expireMs || app.expireMs > Date.now())
                                            ? '{{ i18n "subscription.active" }}'
                                            : '{{ i18n "subscription.inactive" }}' ]]
                                        </a-tag>
                                    </template>
                                </a-descriptions-item>
                                <a-descriptions-item label='{{ i18n "subscription.downloaded" }}'>[[ app.download ]]</a-descriptions-item>
                                <a-descriptions-item label='{{ i18n "subscription.uploaded" }}'>[[ app.upload ]]</a-descriptions-item>
                                <a-descriptions-item label='{{ i18n "usage" }}'>[[ app.used ]]</a-descriptions-item>
                                <a-descriptions-item label='{{ i18n "subscription.totalQuota" }}'>[[ app.total ]]</a-descriptions-item>
                                <a-descriptions-item v-if="app.totalByte > 0" label='{{ i18n "remained" }}'>[[ app.remained ]]</a-descriptions-item>
                                <a-descriptions-item label='{{ i18n "lastOnline" }}'>
                                    <template v-if="app.lastOnlineMs > 0">
                                        <template v-if="app.datepicker === 'gregorian'">
                                            [[ DateUtil.formatMillis(app.lastOnlineMs) ]]
                                        </template>
                                        <template v-else>
                                            [[ DateUtil.convertToJalalian(moment(app.lastOnlineMs)) ]]
                                        </template>
                                    </template>
                                    <template v-else>
                                        <span>-</span>
                                    </template>
                                </a-descriptions-item>
                                <a-descriptions-item label='{{ i18n "subscription.expiry" }}'>
                                      <template v-if="app.expireMs == 0">
                                        {{ i18n "subscription.noExpiry" }}
                                    </template>
                                    <template v-else>
                                        <template v-if="app.datepicker === 'gregorian'">
                                            [[ DateUtil.formatMillis(app.expire) ]]
                                        </template>
                                        <template v-else>
                                            [[ DateUtil.convertToJalalian(moment(app.expire)) ]]
                                        </template>
                                    </template>
                                </a-descriptions-item>
                            </a-descriptions>
                        </a-col>
                    </a-row>

                    <br />
                    <a-list bordered>
                        <a-list-item v-for="(link, idx) in links" :key="link">
                            <div style="width:100%; text-align:center;">
                                <a-button type="primary" :block="isMobile"
                                          @click="copy(link)">[[ linkName(link, idx)
                                ]]</a-button>
                            </div>
                        </a-list-item>
                    </a-list>
                    <br />
                    <h3 class="section-heading">QR Codes</h3>
                    <div class="qr-container-flex">
                        <div class="qr-box">
                            <canvas id="qrcode" class="qr-cv" title='{{ i18n "copy" }}' @click="copy(app.subUrl)"></canvas>
                            <div class="qr-label">{{ i18n "pages.settings.subSettings"}}</div>
                        </div>
                        <div class="qr-box">
                            <canvas id="qrcode-subjson" class="qr-cv" title='{{ i18n "copy" }}' @click="copy(app.subJsonUrl)"></canvas>
                            <div class="qr-label">{{ i18n "pages.settings.subSettings"}} Json</div>
                        </div>
                    </div>
                    <div class="link-buttons">
                        <a-dropdown :trigger="['click']">
                            <a-button class="link-button" size="large">
                                Android <a-icon type="down" />
                            </a-button>
                            <a-menu slot="overlay" :class="themeSwitcher.currentTheme">
                                <a-menu-item key="android-v2box" @click="open('v2box://install-sub?url=' + encodeURIComponent(app.subUrl) + '&name=' + encodeURIComponent(app.sId))">V2Box</a-menu-item>
                                <a-menu-item key="android-v2rayng" @click="open('v2rayng://install-config?url=' + encodeURIComponent(app.subUrl))">V2RayNG</a-menu-item>
                                <a-menu-item key="android-singbox" @click="copy(app.subUrl)">Sing-box</a-menu-item>
                                <a-menu-item key="android-v2raytun" @click="copy(app.subUrl)">V2RayTun</a-menu-item>
                                <a-menu-item key="android-npvtunnel" @click="copy(app.subUrl)">NPV Tunnel</a-menu-item>
                            </a-menu>
                        </a-dropdown>
                        <a-dropdown :trigger="['click']">
                            <a-button class="link-button" size="large">
                                iOS <a-icon type="down" />
                            </a-button>
                            <a-menu slot="overlay" :class="themeSwitcher.currentTheme">
                                <a-menu-item key="ios-shadowrocket" @click="open('shadowrocket://add/subscription?url=' + encodeURIComponent(app.subUrl) + '&remark=' + encodeURIComponent(app.sId))">Shadowrocket</a-menu-item>
                                <a-menu-item key="ios-v2box" @click="open('v2box://install-sub?url=' + encodeURIComponent(app.subUrl) + '&name=' + encodeURIComponent(app.sId))">V2Box</a-menu-item>
                                <a-menu-item key="ios-streisand" @click="open('streisand://import/' + encodeURIComponent(app.subUrl))">Streisand</a-menu-item>
                                <a-menu-item key="ios-v2raytun" @click="copy(app.subUrl)">V2RayTun</a-menu-item>
                                <a-menu-item key="ios-npvtunnel" @click="copy(app.subUrl)">NPV Tunnel</a-menu-item>
                            </a-menu>
                        </a-dropdown>
                    </div>
                </a-card>
            </a-col>
        </a-row>
    </a-layout-content>
    <script>
        function getExpireTs(expire) {
            if (!expire) return 0;
            return typeof expire === 'number' ? expire : new Date(expire).getTime();
        }
    </script>
</a-layout>

<template id="subscription-data" data-sid="{{ .sId }}"
          data-sub-url="{{ .subUrl }}" data-subjson-url="{{ .subJsonUrl }}"
          data-download="{{ .download }}"
          data-upload="{{ .upload }}" data-used="{{ .used }}"
          data-total="{{ .total }}" data-remained="{{ .remained }}"
          data-expire="{{ .expire }}" data-lastonline="{{ .lastOnline }}"
          data-downloadbyte="{{ .downloadByte }}"
          data-uploadbyte="{{ .uploadByte }}" data-totalbyte="{{ .totalByte }}"
          data-datepicker="{{ .datepicker }}"></template>
<textarea id="subscription-links"
          style="display:none">{{ range .result }}{{ . }}
{{ end }}</textarea>

{{template "component/aThemeSwitch" .}}
<script src="{{ .base_path }}assets/js/subscription.js?{{ .cur_ver }}"></script>
<script>
    // Vue instance logic
    document.addEventListener('DOMContentLoaded', function() {
        const dataElement = document.getElementById('subscription-data');
        const appData = {
            sId: dataElement.getAttribute('data-sid'),
            subUrl: dataElement.getAttribute('data-sub-url'),
            subJsonUrl: dataElement.getAttribute('data-subjson-url'),
            download: dataElement.getAttribute('data-download'),
            upload: dataElement.getAttribute('data-upload'),
            used: dataElement.getAttribute('data-used'),
            total: dataElement.getAttribute('data-total'),
            remained: dataElement.getAttribute('data-remained'),
            expire: parseInt(dataElement.getAttribute('data-expire')),
            lastOnline: dataElement.getAttribute('data-lastonline'),
            downloadByte: parseInt(dataElement.getAttribute('data-downloadbyte')),
            uploadByte: parseInt(dataElement.getAttribute('data-uploadbyte')),
            totalByte: parseInt(dataElement.getAttribute('data-totalbyte')),
            lastOnlineMs: parseInt(dataElement.getAttribute('data-lastonline')),
            datepicker: dataElement.getAttribute('data-datepicker')
        };
        const links = document.getElementById('subscription-links').value.trim().split('\n').filter(e => e);

        new Vue({
            el: '#app',
            data() {
                return {
                    app: appData,
                    links: links,
                    lang: LanguageManager.getLanguage(),
                    isMobile: window.innerWidth < 768,
                    chart: null,
                };
            },
            computed: {
                isUnlimited() {
                    return this.app.totalByte === 0;
                },
                isActive() {
                    return this.app.expire > 0 ? this.app.expire > Date.now() : true;
                },
                usagePercentage() {
                    if (this.isUnlimited) return 0;
                    const total = this.app.totalByte;
                    const used = this.app.downloadByte + this.app.uploadByte;
                    return (used / total) * 100;
                },
                remainedPercentage() {
                    return 100 - this.usagePercentage;
                }
            },
            watch: {
                'app.downloadByte': 'updateChart',
                'app.uploadByte': 'updateChart',
                'app.totalByte': 'updateChart',
            },
            mounted() {
                this.initQRCodes();
                this.initChart();
                window.addEventListener('resize', this.handleResize);
            },
            beforeDestroy() {
                window.removeEventListener('resize', this.handleResize);
            },
            methods: {
                handleResize() {
                    this.isMobile = window.innerWidth < 768;
                },
                initQRCodes() {
                    if (this.app.subUrl) {
                        new QRious({
                            element: document.getElementById('qrcode'),
                            value: this.app.subUrl,
                            size: 200
                        });
                    }
                    if (this.app.subJsonUrl) {
                        new QRious({
                            element: document.getElementById('qrcode-subjson'),
                            value: this.app.subJsonUrl,
                            size: 200
                        });
                    }
                },
                initChart() {
                    if (this.isUnlimited) {
                        if (this.chart) {
                            this.chart.destroy();
                            this.chart = null;
                        }
                        return;
                    }
                    const ctx = document.getElementById('usageChart').getContext('2d');
                    const used = this.app.downloadByte + this.app.uploadByte;
                    const remained = this.app.totalByte - used;

                    this.chart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Used', 'Remained'],
                            datasets: [{
                                data: [used, remained > 0 ? remained : 0],
                                backgroundColor: [
                                    'rgba(163, 217, 255, 0.8)',
                                    'rgba(243, 163, 255, 0.8)'
                                ],
                                borderColor: [
                                    'rgba(26, 26, 46, 1)',
                                    'rgba(26, 26, 46, 1)'
                                ],
                                borderWidth: 2,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '80%',
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'bottom',
                                    labels: {
                                        color: '#e0e0e0'
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(tooltipItem) {
                                            const label = tooltipItem.label || '';
                                            const value = tooltipItem.raw;
                                            return `${label}: ${Util.bytesToSize(value)}`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                },
                updateChart() {
                    if (this.chart && !this.isUnlimited) {
                        const used = this.app.downloadByte + this.app.uploadByte;
                        const remained = this.app.totalByte - used;
                        this.chart.data.datasets[0].data = [used, remained > 0 ? remained : 0];
                        this.chart.update();
                    } else if (!this.chart && !this.isUnlimited) {
                        this.initChart();
                    } else if (this.chart && this.isUnlimited) {
                        this.chart.destroy();
                        this.chart = null;
                    }
                },
                copy(text) {
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(text)
                            .then(() => {
                                this.$message.success('{{ i18n "copied" }}');
                            })
                            .catch(err => {
                                this.$message.error('Failed to copy: ' + err);
                            });
                    } else {
                        const el = document.createElement('textarea');
                        el.value = text;
                        document.body.appendChild(el);
                        el.select();
                        document.execCommand('copy');
                        document.body.removeChild(el);
                        this.$message.success('{{ i18n "copied" }}');
                    }
                },
                open(url) {
                    window.open(url, '_blank');
                },
                linkName(url, idx) {
                    const parts = url.split("://");
                    if (parts.length > 1) {
                        return parts[0].replace("ss", "Shadowsocks").replace("vmess", "V2Ray").replace("vless", "VLESS").toUpperCase();
                    }
                    return "{{ i18n "subscription.copyLink" }} " + (idx + 1);
                }
            }
        });
    });
</script>

{{ template "page/body_end" .}}